<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="/vite.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Prueba - Aplicaci贸n Distribuida</title>
  </head>
  <body>
    <div id="root"></div>
    
    <!-- Script de detecci贸n de Circuit Breaker - Se ejecuta ANTES que React -->
    <script>
      // FORZAR EJECUCIN INMEDIATA - No esperar a nada
      try {
        console.error(' [CB INLINE] ====== INICIANDO SCRIPT CB ======');
        console.error(' [CB INLINE] Timestamp:', new Date().toISOString());
        console.error(' [CB INLINE] typeof XMLHttpRequest:', typeof XMLHttpRequest);
        
        (function() {
          console.error(' [CB INLINE] Script de detecci贸n de CB cargado');
          
          // Estado global del circuit breaker para admin
          window.__CB_STATE__ = {
            isOpen: false,
            error: null,
            notification: null
          };
          
          // Estado global del circuit breaker para m茅dico
          window.__CB_STATE_MEDICO__ = {
            isOpen: false,
            error: null,
            notification: null
          };
          
          // Timers para auto-ocultar notificaciones
          let notificationTimeout = null;
          let notificationMedicoTimeout = null;
          // Banderas para evitar m煤ltiples notificaciones simult谩neas
          let isNotificationVisible = false;
          let isNotificationMedicoVisible = false;
          // ltimos momentos en que se mostraron notificaciones (para evitar spam)
          let lastNotificationTime = 0;
          let lastNotificationMedicoTime = 0;
          const NOTIFICATION_COOLDOWN = 2000; // 2 segundos entre notificaciones
          
          // Funci贸n para detectar si estamos en una ruta del frontend m茅dico
          function isMedicoRoute() {
            const path = window.location.pathname;
            return path.startsWith('/medico/') || path === '/medico';
          }
          
          // Funci贸n para mostrar/ocultar notificaci贸n (admin)
          function updateNotification(isOpen, error) {
            window.__CB_STATE__.isOpen = isOpen;
            window.__CB_STATE__.error = error;
            
            // Si ya hay una notificaci贸n visible Y est谩 intentando mostrar otra
            // Y no ha pasado el cooldown, ignorar
            const now = Date.now();
            if (isOpen && isNotificationVisible && (now - lastNotificationTime < NOTIFICATION_COOLDOWN)) {
              console.error(' [CB INLINE] Notificaci贸n ya visible, ignorando duplicado');
              return;
            }
            
            // Limpiar timer anterior si existe
            if (notificationTimeout) {
              clearTimeout(notificationTimeout);
              notificationTimeout = null;
            }
            
            // Eliminar notificaci贸n anterior si existe
            const existing = document.getElementById('cb-notification');
            if (existing) {
              existing.remove();
              isNotificationVisible = false;
            }
            
            if (isOpen) {
              // Verificar nuevamente antes de crear (por si hubo una condici贸n de carrera)
              if (document.getElementById('cb-notification')) {
                console.error(' [CB INLINE] Notificaci贸n a煤n existe en DOM, abortando');
                return;
              }
              
              lastNotificationTime = now;
              isNotificationVisible = true;
              // Crear notificaci贸n
              const notification = document.createElement('div');
              notification.id = 'cb-notification';
              notification.style.cssText = 'position: fixed; top: 16px; right: 16px; z-index: 99999; max-width: 400px; background: #fef2f2; border: 2px solid #fca5a5; border-radius: 12px; padding: 16px; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); animation: slideIn 0.3s ease-out;';
              
              const errorMsg = error?.message || 'El servicio de administraci贸n est谩 temporalmente no disponible. Por favor, intenta nuevamente en unos momentos.';
              
              notification.innerHTML = `
                <div style="display: flex; align-items: start; gap: 12px;">
                  <div style="flex-shrink: 0; width: 40px; height: 40px; background: #fee2e2; border-radius: 8px; display: flex; align-items: center; justify-content: center; animation: pulse 2s infinite;">
                    <span style="font-size: 24px;">锔</span>
                  </div>
                  <div style="flex: 1;">
                    <h4 style="font-weight: bold; color: #991b1b; font-size: 14px; margin: 0 0 4px 0;">
                      锔 Servicio no disponible
                    </h4>
                    <p style="color: #7f1d1d; font-size: 13px; margin: 0; line-height: 1.5;">
                      ${errorMsg}
                    </p>
                    <p style="color: #9f1239; font-size: 11px; margin: 8px 0 0 0; font-style: italic;">
                      El sistema intentar谩 reconectarse autom谩ticamente cuando el servicio est茅 disponible.
                    </p>
                  </div>
                </div>
                <style>
                  @keyframes pulse {
                    0%, 100% { opacity: 1; }
                    50% { opacity: 0.7; }
                  }
                  @keyframes slideIn {
                    from {
                      transform: translateX(100%);
                      opacity: 0;
                    }
                    to {
                      transform: translateX(0);
                      opacity: 1;
                    }
                  }
                  @keyframes slideOut {
                    from {
                      transform: translateX(0);
                      opacity: 1;
                    }
                    to {
                      transform: translateX(100%);
                      opacity: 0;
                    }
                  }
                </style>
              `;
              
              document.body.appendChild(notification);
              console.error(' [CB INLINE] Notificaci贸n creada');
              
              // Auto-ocultar despu茅s de 6 segundos
              notificationTimeout = setTimeout(function() {
                const notif = document.getElementById('cb-notification');
                if (notif) {
                  notif.style.animation = 'slideOut 0.3s ease-out';
                  setTimeout(function() {
                    if (notif && notif.parentNode) {
                      notif.remove();
                    }
                    isNotificationVisible = false;
                  }, 300);
                }
                notificationTimeout = null;
              }, 6000); // 6 segundos
            } else {
              // Si se est谩 cerrando la notificaci贸n, actualizar bandera
              isNotificationVisible = false;
            }
          }
          
          // Funci贸n para mostrar/ocultar notificaci贸n (m茅dico)
          function updateNotificationMedico(isOpen, error) {
            window.__CB_STATE_MEDICO__.isOpen = isOpen;
            window.__CB_STATE_MEDICO__.error = error;
            
            // Solo mostrar si estamos en una ruta m茅dica
            if (!isMedicoRoute()) {
              return;
            }
            
            // Si ya hay una notificaci贸n visible Y est谩 intentando mostrar otra
            // Y no ha pasado el cooldown, ignorar
            const now = Date.now();
            if (isOpen && isNotificationMedicoVisible && (now - lastNotificationMedicoTime < NOTIFICATION_COOLDOWN)) {
              console.error(' [CB MEDICO INLINE] Notificaci贸n ya visible, ignorando duplicado');
              return;
            }
            
            // Limpiar timer anterior si existe
            if (notificationMedicoTimeout) {
              clearTimeout(notificationMedicoTimeout);
              notificationMedicoTimeout = null;
            }
            
            // Eliminar notificaci贸n anterior si existe
            const existing = document.getElementById('cb-notification-medico');
            if (existing) {
              existing.remove();
              isNotificationMedicoVisible = false;
            }
            
            if (isOpen) {
              // Verificar nuevamente antes de crear (por si hubo una condici贸n de carrera)
              if (document.getElementById('cb-notification-medico')) {
                console.error(' [CB MEDICO INLINE] Notificaci贸n a煤n existe en DOM, abortando');
                return;
              }
              
              lastNotificationMedicoTime = now;
              isNotificationMedicoVisible = true;
              // Crear notificaci贸n
              const notification = document.createElement('div');
              notification.id = 'cb-notification-medico';
              notification.style.cssText = 'position: fixed; top: 16px; right: 16px; z-index: 99999; max-width: 400px; background: #f0fdf4; border: 2px solid #86efac; border-radius: 12px; padding: 16px; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); animation: slideIn 0.3s ease-out;';
              
              const errorMsg = error?.message || 'El servicio m茅dico est谩 temporalmente no disponible. Por favor, intenta nuevamente en unos momentos.';
              
              notification.innerHTML = `
                <div style="display: flex; align-items: start; gap: 12px;">
                  <div style="flex-shrink: 0; width: 40px; height: 40px; background: #dcfce7; border-radius: 8px; display: flex; align-items: center; justify-content: center; animation: pulse 2s infinite;">
                    <span style="font-size: 24px;"></span>
                  </div>
                  <div style="flex: 1;">
                    <h4 style="font-weight: bold; color: #166534; font-size: 14px; margin: 0 0 4px 0;">
                      锔 Servicio m茅dico no disponible
                    </h4>
                    <p style="color: #15803d; font-size: 13px; margin: 0; line-height: 1.5;">
                      ${errorMsg}
                    </p>
                    <p style="color: #16a34a; font-size: 11px; margin: 8px 0 0 0; font-style: italic;">
                      El sistema intentar谩 reconectarse autom谩ticamente cuando el servicio est茅 disponible.
                    </p>
                  </div>
                </div>
              `;
              
              document.body.appendChild(notification);
              console.error(' [CB MEDICO INLINE] Notificaci贸n creada');
              
              // Auto-ocultar despu茅s de 6 segundos
              notificationMedicoTimeout = setTimeout(function() {
                const notif = document.getElementById('cb-notification-medico');
                if (notif) {
                  notif.style.animation = 'slideOut 0.3s ease-out';
                  setTimeout(function() {
                    if (notif && notif.parentNode) {
                      notif.remove();
                    }
                    isNotificationMedicoVisible = false;
                  }, 300);
                }
                notificationMedicoTimeout = null;
              }, 6000); // 6 segundos
            } else {
              // Si se est谩 cerrando la notificaci贸n, actualizar bandera
              isNotificationMedicoVisible = false;
            }
          }
          
          // Detectar cambios de p谩gina/ruta para volver a mostrar la notificaci贸n si el servicio sigue ca铆do
          let lastUrl = window.location.href;
          setInterval(function() {
            const currentUrl = window.location.href;
            const isMedico = isMedicoRoute();
            
            if (currentUrl !== lastUrl) {
              // Para admin
              if (!isMedico && window.__CB_STATE__.isOpen && !isNotificationVisible) {
                console.error(' [CB INLINE] Navegaci贸n detectada, servicio admin sigue ca铆do - mostrando notificaci贸n');
                lastNotificationTime = 0;
                updateNotification(true, window.__CB_STATE__.error);
              }
              
              // Para m茅dico
              if (isMedico && window.__CB_STATE_MEDICO__.isOpen && !isNotificationMedicoVisible) {
                console.error(' [CB MEDICO INLINE] Navegaci贸n detectada, servicio m茅dico sigue ca铆do - mostrando notificaci贸n');
                lastNotificationMedicoTime = 0;
                updateNotificationMedico(true, window.__CB_STATE_MEDICO__.error);
              }
            }
            lastUrl = currentUrl;
          }, 500);
          
          // Interceptar XMLHttpRequest
          const originalXHROpen = XMLHttpRequest.prototype.open;
          const originalXHRSend = XMLHttpRequest.prototype.send;
          const xhrUrlMap = new WeakMap();
          
          XMLHttpRequest.prototype.open = function(method, url, ...rest) {
            const fullUrl = typeof url === 'string' ? url : url.toString();
            xhrUrlMap.set(this, fullUrl);
            return originalXHROpen.apply(this, [method, url, ...rest]);
          };
          
          XMLHttpRequest.prototype.send = function(...args) {
            const xhr = this;
            const url = xhrUrlMap.get(xhr) || '';
            
            // Agregar listener ANTES de enviar
            xhr.addEventListener('load', function() {
              const status = xhr.status;
              const responseUrl = url || xhr.responseURL || '';
              const normalizedUrl = responseUrl.toLowerCase();
              
              console.error(' [CB INLINE] Evento load:', {
                status: status,
                url: responseUrl,
                normalizedUrl: normalizedUrl
              });
              
              // Detectar si es servicio m茅dico o admin
              const isMedicoService = normalizedUrl.includes('/medico/') || 
                                     normalizedUrl.includes('/medico?') ||
                                     normalizedUrl.includes('medico-service') ||
                                     normalizedUrl.includes('api/medico') ||
                                     (normalizedUrl.includes('/medico') && !normalizedUrl.includes('/medicos')); // /medicos es admin, /medico es m茅dico
              
              if (status === 503) {
                if (isMedicoService) {
                  // Error 503 del servicio m茅dico
                  console.error(' [CB MEDICO INLINE] 锔锔锔 DETECTADO 503 MDICO 锔锔锔:', {
                    url: responseUrl,
                    status,
                    statusText: xhr.statusText,
                    isMedicoService: true,
                    notificacionVisible: isNotificationMedicoVisible
                  });
                  
                  const errorInfo = {
                    status: 503,
                    code: 'CIRCUIT_OPEN',
                    message: 'El servicio m茅dico est谩 temporalmente no disponible'
                  };
                  
                  // Actualizar estado global del m茅dico
                  window.__CB_STATE_MEDICO__.isOpen = true;
                  window.__CB_STATE_MEDICO__.error = errorInfo;
                  
                  // Solo mostrar si estamos en ruta m茅dica
                  if (isMedicoRoute()) {
                    updateNotificationMedico(true, errorInfo);
                  }
                } else {
                  // Error 503 del servicio admin
                  console.error(' [CB INLINE] 锔锔锔 DETECTADO 503 ADMIN 锔锔锔:', {
                    url: responseUrl,
                    status,
                    statusText: xhr.statusText,
                    isMedicoService: false,
                    notificacionVisible: isNotificationVisible
                  });
                  
                  const errorInfo = {
                    status: 503,
                    code: 'CIRCUIT_OPEN',
                    message: 'El servicio de administraci贸n est谩 temporalmente no disponible'
                  };
                  
                  // Actualizar estado global primero
                  window.__CB_STATE__.isOpen = true;
                  window.__CB_STATE__.error = errorInfo;
                  
                  // Solo mostrar si NO estamos en ruta m茅dica
                  if (!isMedicoRoute()) {
                    updateNotification(true, errorInfo);
                  }
                }
              } else if (status >= 200 && status < 300) {
                // Si hay una respuesta exitosa, cerrar notificaciones correspondientes
                if (isMedicoService && window.__CB_STATE_MEDICO__.isOpen) {
                  console.error(' [CB MEDICO INLINE] Servicio m茅dico disponible - cerrando notificaci贸n');
                  window.__CB_STATE_MEDICO__.isOpen = false;
                  window.__CB_STATE_MEDICO__.error = null;
                  updateNotificationMedico(false, null);
                } else if (!isMedicoService && window.__CB_STATE__.isOpen) {
                  console.error(' [CB INLINE] Servicio admin disponible - cerrando notificaci贸n');
                  window.__CB_STATE__.isOpen = false;
                  window.__CB_STATE__.error = null;
                  updateNotification(false, null);
                }
              }
            }, false);
            
            // Tambi茅n interceptar errores
            xhr.addEventListener('error', function() {
              console.error(' [CB INLINE] Error en XHR:', {
                url: url || xhr.responseURL || '',
                status: xhr.status
              });
            });
            
            return originalXHRSend.apply(this, args);
          };
          
          console.error(' [CB INLINE] Interceptores XMLHttpRequest configurados');
          console.error(' [CB INLINE] XMLHttpRequest.prototype.open sobrescrito:', XMLHttpRequest.prototype.open !== originalXHROpen);
          console.error(' [CB INLINE] XMLHttpRequest.prototype.send sobrescrito:', XMLHttpRequest.prototype.send !== originalXHRSend);
          
          // Interceptar tambi茅n fetch (usado por client.medico.js)
          const originalFetch = window.fetch;
          window.fetch = function(...args) {
            const url = args[0];
            const urlString = typeof url === 'string' ? url : url.toString();
            const normalizedUrl = urlString.toLowerCase();
            
            const isMedicoService = normalizedUrl.includes('/medico/') || 
                                   normalizedUrl.includes('/medico?') ||
                                   normalizedUrl.includes('medico-service') ||
                                   normalizedUrl.includes('api/medico') ||
                                   (normalizedUrl.includes('/medico') && !normalizedUrl.includes('/medicos'));
            
            return originalFetch.apply(this, args)
              .then(response => {
                // Interceptar respuesta
                if (response.status === 503) {
                  if (isMedicoService) {
                    console.error(' [CB MEDICO FETCH] 锔锔锔 DETECTADO 503 MDICO 锔锔锔:', {
                      url: urlString,
                      status: response.status,
                      isMedicoService: true
                    });
                    
                    const errorInfo = {
                      status: 503,
                      code: 'CIRCUIT_OPEN',
                      message: 'El servicio m茅dico est谩 temporalmente no disponible'
                    };
                    
                    window.__CB_STATE_MEDICO__.isOpen = true;
                    window.__CB_STATE_MEDICO__.error = errorInfo;
                    
                    if (isMedicoRoute()) {
                      updateNotificationMedico(true, errorInfo);
                    }
                  } else {
                    const errorInfo = {
                      status: 503,
                      code: 'CIRCUIT_OPEN',
                      message: 'El servicio de administraci贸n est谩 temporalmente no disponible'
                    };
                    
                    window.__CB_STATE__.isOpen = true;
                    window.__CB_STATE__.error = errorInfo;
                    
                    if (!isMedicoRoute()) {
                      updateNotification(true, errorInfo);
                    }
                  }
                } else if (response.status >= 200 && response.status < 300) {
                  // Si hay una respuesta exitosa, cerrar notificaciones correspondientes
                  if (isMedicoService && window.__CB_STATE_MEDICO__.isOpen) {
                    window.__CB_STATE_MEDICO__.isOpen = false;
                    window.__CB_STATE_MEDICO__.error = null;
                    updateNotificationMedico(false, null);
                  } else if (!isMedicoService && window.__CB_STATE__.isOpen) {
                    window.__CB_STATE__.isOpen = false;
                    window.__CB_STATE__.error = null;
                    updateNotification(false, null);
                  }
                }
                
                return response;
              })
              .catch(error => {
                // Si hay un error de red, tambi茅n podr铆a ser circuit breaker
                const normalizedUrl = (typeof url === 'string' ? url : url.toString()).toLowerCase();
                const isMedicoService = normalizedUrl.includes('/medico/') || 
                                       normalizedUrl.includes('/medico?') ||
                                       normalizedUrl.includes('medico-service') ||
                                       normalizedUrl.includes('api/medico') ||
                                       (normalizedUrl.includes('/medico') && !normalizedUrl.includes('/medicos'));
                
                if (isMedicoService && isMedicoRoute()) {
                  const errorInfo = {
                    status: 503,
                    code: 'NETWORK_ERROR',
                    message: 'El servicio m茅dico no responde. Verificando estado...'
                  };
                  
                  window.__CB_STATE_MEDICO__.isOpen = true;
                  window.__CB_STATE_MEDICO__.error = errorInfo;
                  updateNotificationMedico(true, errorInfo);
                }
                
                throw error;
              });
          };
          
          console.error(' [CB MEDICO INLINE] Interceptor fetch configurado');
        })();
      } catch(e) {
        console.error(' [CB INLINE] ERROR al configurar interceptores:', e);
      }
    </script>
    
    <script type="module" src="/src/main.jsx"></script>
  </body>
</html>
